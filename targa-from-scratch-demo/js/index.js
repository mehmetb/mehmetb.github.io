(()=>{function d(...o){let e=o.reduce((n,s)=>n+s.byteLength,0),i=new ArrayBuffer(e),t=new Uint8Array(i),r=0;for(let n of o){let s=new Uint8Array(n);for(let a of s)t[r++]=a}return i}function u(o){return new Promise((e,i)=>{let t=new FileReader;t.addEventListener("load",()=>{let r=t.result;e(r)}),t.addEventListener("error",i),t.readAsArrayBuffer(o)})}var c=(a=>(a[a.NO_IMAGE_DATA=0]="NO_IMAGE_DATA",a[a.COLOR_MAPPED=1]="COLOR_MAPPED",a[a.TRUE_COLOR=2]="TRUE_COLOR",a[a.GRAY_SCALE=3]="GRAY_SCALE",a[a.RUN_LENGTH_ENCODED_COLOR_MAPPED=9]="RUN_LENGTH_ENCODED_COLOR_MAPPED",a[a.RUN_LENGTH_ENCODED_TRUE_COLOR=10]="RUN_LENGTH_ENCODED_TRUE_COLOR",a[a.RUN_LENGTH_ENCODED_GRAY_SCALE=11]="RUN_LENGTH_ENCODED_GRAY_SCALE",a))(c||{});var l=class{decodedArrayBuffer;readerDataView;writerDataView;pixelSize;readCursor=0;writeCursor=0;constructor(e,i,t,r){this.decodedArrayBuffer=new ArrayBuffer(i*t*r),this.readerDataView=new DataView(e),this.writerDataView=new DataView(this.decodedArrayBuffer),this.pixelSize=r}read(){let e=this.readerDataView.getUint8(this.readCursor);return this.readCursor+=1,e}write(e){this.writerDataView.setUint8(this.writeCursor,e),this.writeCursor+=1}readNextPixel(){let e=[];for(let i=0;i<this.pixelSize;++i)e.push(this.read());return e}writePixel(e){for(let i of e)this.write(i)}decode(){for(;this.writeCursor<this.writerDataView.byteLength;){let e=this.read();if(e>=128){let i=e-128,t=this.readNextPixel();for(let r=0;r<=i;++r)this.writePixel(t)}else{let i=e;for(let t=0;t<=i;++t){let r=this.readNextPixel();this.writePixel(r)}}}return this.decodedArrayBuffer}};function f(o,e,i,t){return new l(o,e,i,t).decode()}var h=class{arrayBuffer;dataView;colorMapType;imageType;xOrigin;yOrigin;imageWidth;imageHeight;pixelSize;imageDescriptor;imageIdentificationFieldLength;imageDataFieldOffset;colorMapOrigin;colorMapLength;colorMapPixelSize;version;constructor(e){this.arrayBuffer=e,this.dataView=new DataView(e),this.imageIdentificationFieldLength=this.dataView.getUint8(0),this.colorMapType=this.dataView.getUint8(1),this.imageType=this.dataView.getUint8(2),this.colorMapOrigin=this.dataView.getUint16(3,!0),this.colorMapLength=this.dataView.getUint16(5,!0),this.colorMapPixelSize=this.dataView.getUint8(7)/8,this.xOrigin=this.dataView.getUint16(8),this.yOrigin=this.dataView.getUint16(10),this.imageWidth=this.dataView.getUint16(12,!0),this.imageHeight=this.dataView.getUint16(14,!0),this.pixelSize=this.dataView.getUint8(16)/8,this.imageDescriptor=this.dataView.getUint8(17),this.imageDataFieldOffset=this.getImageDataFieldOffset(),this.detectVersion()}detectVersion(){let e="TRUEVISION-XFILE.\0",i=this.arrayBuffer.slice(-18),r=new TextDecoder().decode(i);this.version=r===e?2:1}getImageDataFieldOffset(){switch(this.colorMapType){case 0:return 18+this.imageIdentificationFieldLength;case 1:return 18+this.imageIdentificationFieldLength+this.colorMapLength*this.colorMapPixelSize;default:throw new Error(`Color Map Type "${this.colorMapType}" is not supported!`)}}isTopToBottom(){return(4&this.imageDescriptor)===4}getPixelOffset(e,i){let t;if(this.isTopToBottom()?t=i*this.imageWidth*this.pixelSize+e*this.pixelSize:t=(this.imageHeight-i-1)*this.imageWidth*this.pixelSize+e*this.pixelSize,t+=this.imageDataFieldOffset,this.colorMapType===0)return t;if(this.colorMapType===1)return this.pixelSize===2?t=this.dataView.getUint16(t,!0):t=this.dataView.getUint8(t),18+this.imageIdentificationFieldLength+this.colorMapOrigin+t*this.colorMapPixelSize;throw new Error(`Color map type ${this.colorMapType} is not supported`)}getPixelColor(e,i){let t=this.colorMapType===0?this.pixelSize:this.colorMapPixelSize,r=this.getPixelOffset(e,i);switch(t){case 3:{let n=this.dataView.getUint8(r),s=this.dataView.getUint8(r+1);return{red:this.dataView.getUint8(r+2),green:s,blue:n,alpha:255}}default:throw new Error(`Pixel Size (${this.pixelSize}) is not supported!`)}}decodeRunLengthEncoding(){let e=f(this.arrayBuffer.slice(this.imageDataFieldOffset),this.imageWidth,this.imageHeight,this.pixelSize),i=this.arrayBuffer.slice(0,this.imageDataFieldOffset);this.arrayBuffer=d(i,e),this.dataView=new DataView(this.arrayBuffer)}draw(e){let i=e.getContext("2d");if(!i){alert("Failed to get canvas context");return}this.imageType>8&&this.decodeRunLengthEncoding(),i.clearRect(0,0,e.width,e.height),e.width=this.imageWidth,e.height=this.imageHeight;let t=i.createImageData(this.imageWidth,this.imageHeight);for(let r=0;r<this.imageHeight;++r)for(let n=0;n<this.imageWidth;++n){let s=this.getPixelColor(n,r),a=r*this.imageWidth*4+n*4;t.data[a]=s.red,t.data[a+1]=s.green,t.data[a+2]=s.blue,t.data[a+3]=s.alpha}i.putImageData(t,0,0)}toTable(){let e=this.getStats(),i={};for(let[t,r]of Object.entries(e)){let s=`${t[0].toUpperCase()}${t.replace(/([A-Z])/g," $1").substring(1)}`;i[s]=r}return i}getStats(){return{version:this.version,colorMapType:this.colorMapType,imageType:c[this.imageType],xOrigin:this.xOrigin,yOrigin:this.yOrigin,imageWidth:this.imageWidth,imageHeight:this.imageHeight,pixelSize:this.pixelSize,imageDescriptor:this.imageDescriptor.toString(2),imageIdentificationFieldLength:this.imageIdentificationFieldLength,topToBottom:this.isTopToBottom(),colorMapOrigin:this.colorMapOrigin,colorMapLength:this.colorMapLength,colorMapPixelSize:this.colorMapPixelSize}}};new EventSource("/esbuild").addEventListener("change",()=>location.reload());var g=document.querySelector("input[type=file]"),m=document.querySelector("canvas"),p=document.querySelector("table"),w=document.querySelector("#row");function x(o){p.innerHTML="";let e=o.toTable();for(let[i,t]of Object.entries(e)){let r=w.content.cloneNode(!0),n=r.querySelectorAll("td");n[0].innerText=i,n[1].innerText=t,p.appendChild(r)}console.table(e)}async function y(){try{let{files:o}=g;if(!o?.length)return;let e=o.item(0);if(!e)return;let i=await u(e),t=new h(i);x(t),t.draw(m)}catch(o){alert(o.message)}}g.addEventListener("change",()=>{y()});})();
