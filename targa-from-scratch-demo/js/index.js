(()=>{var f=(o=>(o[o.NO_IMAGE_DATA=0]="NO_IMAGE_DATA",o[o.COLOR_MAPPED=1]="COLOR_MAPPED",o[o.TRUE_COLOR=2]="TRUE_COLOR",o[o.GRAY_SCALE=3]="GRAY_SCALE",o[o.RUN_LENGTH_ENCODED_COLOR_MAPPED=9]="RUN_LENGTH_ENCODED_COLOR_MAPPED",o[o.RUN_LENGTH_ENCODED_TRUE_COLOR=10]="RUN_LENGTH_ENCODED_TRUE_COLOR",o[o.RUN_LENGTH_ENCODED_GRAY_SCALE=11]="RUN_LENGTH_ENCODED_GRAY_SCALE",o))(f||{});function d(...n){let e=n.reduce((s,a)=>s+a.byteLength,0),r=new ArrayBuffer(e),t=new Uint8Array(r),i=0;for(let s of n){let a=new Uint8Array(s);for(let o of a)t[i++]=o}return r}function m(n){return new Promise((e,r)=>{let t=new FileReader;t.addEventListener("load",()=>{let i=t.result;e(i)}),t.addEventListener("error",r),t.readAsArrayBuffer(n)})}function O(n){return n.replace(/\b(\w)/g,(e,r)=>r.toUpperCase())}function g(n){let e={version:n.version,imageType:O(f[n.imageType].toLowerCase().replace(/_/g," ")),xOrigin:n.xOrigin,yOrigin:n.yOrigin,imageWidth:n.imageWidth,imageHeight:n.imageHeight,pixelSize:n.pixelSize,imageDescriptor:n.imageDescriptor.toString(2).padStart(8,"0"),imageIdentificationFieldLength:n.imageIdentificationFieldLength,topToBottom:n.isTopToBottom(),colorMapOrigin:n.colorMapOrigin,colorMapLength:n.colorMapLength,colorMapPixelSize:n.colorMapPixelSize,RLEDecodeDuration:`${n.durations.RLEDecodeDuration} ms`,DrawDuration:`${n.durations.CanvasDrawDuration} ms`},r={};for(let[t,i]of Object.entries(e)){let a=`${t[0].toUpperCase()}${t.replace(/(?!\b[A-Z])([A-Z])/g," $1").substring(1)}`;if(typeof i=="boolean"){r[a]=i?"Yes":"No";continue}r[a]=i}return r}var p=class{decodedArrayBuffer;readerBytes;writerBytes;pixelSize;readCursor=0;writeCursor=0;constructor(e,r,t,i){this.decodedArrayBuffer=new ArrayBuffer(r*t*i),this.readerBytes=new Uint8Array(e),this.writerBytes=new Uint8Array(this.decodedArrayBuffer),this.pixelSize=i}read(){let e=this.readerBytes[this.readCursor];return this.readCursor+=1,e}write(e){this.writerBytes[this.writeCursor]=e,this.writeCursor+=1}readNextPixel(){let e=[];for(let r=0;r<this.pixelSize;++r)e.push(this.read());return e}writePixel(e){for(let r of e)this.write(r)}decode(){for(;this.writeCursor<this.writerBytes.byteLength;){let e=this.read();if(e>=128){let r=e-128,t=this.readNextPixel();for(let i=0;i<=r;++i)this.writePixel(t)}else{let r=e;for(let t=0;t<=r;++t){let i=this.readNextPixel();this.writePixel(i)}}}return this.decodedArrayBuffer}};function b(n,e,r,t){return new p(n,e,r,t).decode()}var c=class n{static GRID_SIZE=30;#e;dataView;bytes;colorMapType;imageType;xOrigin;yOrigin;imageWidth;imageHeight;pixelSize;imageDescriptor;imageIdentificationFieldLength;imageDataFieldOffset;colorMapOrigin;colorMapLength;colorMapPixelSize;extensionOffset;version;durations={RLEDecodeDuration:0,CanvasDrawDuration:0};get arrayBuffer(){return this.#e}set arrayBuffer(e){this.#e=e,this.dataView=new DataView(e),this.bytes=new Uint8Array(e)}constructor(e){if(this.arrayBuffer=e,this.imageIdentificationFieldLength=this.bytes[0],this.colorMapType=this.bytes[1],this.imageType=this.bytes[2],this.colorMapOrigin=this.dataView.getUint16(3,!0),this.colorMapLength=this.dataView.getUint16(5,!0),this.colorMapPixelSize=this.bytes[7]/8,this.xOrigin=this.bytes[8],this.yOrigin=this.bytes[10],this.imageWidth=this.dataView.getUint16(12,!0),this.imageHeight=this.dataView.getUint16(14,!0),this.pixelSize=this.bytes[16]/8,this.imageDescriptor=this.bytes[17],this.imageDataFieldOffset=this.getImageDataFieldOffset(),this.detectVersion(),this.imageType>8){let r=performance.now();this.decodeRunLengthEncoding();let t=performance.now();this.durations.RLEDecodeDuration=t-r}this.version===2&&(this.extensionOffset=this.dataView.getUint32(this.dataView.byteLength-26,!0))}detectVersion(){let e="TRUEVISION-XFILE.\0",r=this.arrayBuffer.slice(-18),i=new TextDecoder().decode(r);this.version=i===e?2:1}decodeRunLengthEncoding(){let e=b(this.arrayBuffer.slice(this.imageDataFieldOffset),this.imageWidth,this.imageHeight,this.pixelSize);switch(this.version){case 1:{let r=this.arrayBuffer.slice(0,this.imageDataFieldOffset);this.arrayBuffer=d(r,e);break}case 2:{let r=this.arrayBuffer.slice(0,this.imageDataFieldOffset),t;this.extensionOffset!==0?t=this.arrayBuffer.slice(this.extensionOffset):t=this.arrayBuffer.slice(-26),this.arrayBuffer=d(r,e,t);break}}}getImageDataFieldOffset(){switch(this.colorMapType){case 0:return 18+this.imageIdentificationFieldLength;case 1:return 18+this.imageIdentificationFieldLength+this.colorMapLength*this.colorMapPixelSize;default:throw new Error(`Color Map Type "${this.colorMapType}" is not supported!`)}}isTopToBottom(){return(this.imageDescriptor&16)===16}getPixelOffset(e,r){let t;if(this.isTopToBottom()?t=r*this.imageWidth*this.pixelSize+e*this.pixelSize:t=(this.imageHeight-r-1)*this.imageWidth*this.pixelSize+e*this.pixelSize,t+=this.imageDataFieldOffset,this.colorMapType===0)return t;if(this.colorMapType===1)return this.pixelSize===2?t=this.dataView.getUint16(t,!0):t=this.bytes[t],18+this.imageIdentificationFieldLength+this.colorMapOrigin+t*this.colorMapPixelSize;throw new Error(`Color map type ${this.colorMapType} is not supported`)}getPixelColor(e,r){let t=this.colorMapType===0?this.pixelSize:this.colorMapPixelSize,i=this.getPixelOffset(e,r);switch(t){case 1:{let s=this.bytes[i];return{red:s,green:s,blue:s,alpha:255}}case 3:{let s=this.bytes[i],a=this.bytes[i+1];return{red:this.bytes[i+2],green:a,blue:s,alpha:255}}case 4:{let s=this.bytes[i],a=this.bytes[i+1],o=this.bytes[i+2],u=this.bytes[i+3];return{blue:s,green:a,red:o,alpha:u}}default:throw new Error(`Pixel Size (${this.pixelSize}) is not supported!`)}}static getCanvasBackgroundColor(e,r){let t=Math.floor(e/this.GRID_SIZE)%2===0,i=Math.floor(r/this.GRID_SIZE)%2===0;return Number(t)^Number(i)?{red:100,green:100,blue:100,alpha:255}:{red:180,green:180,blue:180,alpha:255}}static blendColors(e,r){let t=r.alpha/255,i=1-t;return{red:Math.min(255,r.red*t+e.red*i),green:Math.min(255,r.green*t+e.green*i),blue:Math.min(255,r.blue*t+e.blue*i),alpha:255}}draw(e){let r=performance.now(),t=e.getContext("2d");if(!t){alert("Failed to get canvas context");return}t.clearRect(0,0,e.width,e.height),e.width=this.imageWidth,e.height=this.imageHeight;let i=t.createImageData(this.imageWidth,this.imageHeight);for(let a=0;a<this.imageHeight;++a)for(let o=0;o<this.imageWidth;++o){let u=this.getPixelColor(o,a),h=a*this.imageWidth*4+o*4,x=n.getCanvasBackgroundColor(o,a),l=n.blendColors(x,u);i.data[h]=l.red,i.data[h+1]=l.green,i.data[h+2]=l.blue,i.data[h+3]=l.alpha}t.putImageData(i,0,0);let s=performance.now();this.durations.CanvasDrawDuration=s-r}};new EventSource("/esbuild").addEventListener("change",()=>location.reload());var w=document.querySelector("input[type=file]"),D=document.querySelector("canvas"),y=document.querySelector("table"),B=document.querySelector("#row");function T(n){y.innerHTML="";let e=g(n);for(let[r,t]of Object.entries(e)){let i=B.content.cloneNode(!0),s=i.querySelectorAll("td");s[0].innerText=r,s[1].innerText=t,y.appendChild(i)}console.table(e)}async function A(){try{let{files:n}=w;if(!n?.length)return;let e=n.item(0);if(!e)return;let r=await m(e),t=new c(r);T(t),t.draw(D)}catch(n){alert(n.message)}}w.addEventListener("change",()=>{A()});})();
