(()=>{function c(s){return new Promise((e,i)=>{let t=new FileReader;t.addEventListener("load",()=>{let r=t.result;e(r)}),t.addEventListener("error",i),t.readAsArrayBuffer(s)})}var l=(n=>(n[n.NO_IMAGE_DATA=0]="NO_IMAGE_DATA",n[n.COLOR_MAPPED=1]="COLOR_MAPPED",n[n.TRUE_COLOR=2]="TRUE_COLOR",n[n.GRAY_SCALE=3]="GRAY_SCALE",n[n.RUN_LENGTH_ENCODED_COLOR_MAPPED=9]="RUN_LENGTH_ENCODED_COLOR_MAPPED",n[n.RUN_LENGTH_ENCODED_TRUE_COLOR=10]="RUN_LENGTH_ENCODED_TRUE_COLOR",n[n.RUN_LENGTH_ENCODED_GRAY_SCALE=11]="RUN_LENGTH_ENCODED_GRAY_SCALE",n))(l||{});var d=class{decodedArrayBuffer;readerDataView;writerDataView;pixelSize;readCursor=0;writeCursor=0;constructor(e,i,t,r){this.decodedArrayBuffer=new ArrayBuffer(i*t*r),this.readerDataView=new DataView(e),this.writerDataView=new DataView(this.decodedArrayBuffer),this.pixelSize=r}read(){let e=this.readerDataView.getUint8(this.readCursor);return this.readCursor+=1,e}write(e){this.writerDataView.setUint8(this.writeCursor,e),this.writeCursor+=1}readNextPixel(){let e=[];for(let i=0;i<this.pixelSize;++i)e.push(this.read());return e}writePixel(e){for(let i of e)this.write(i)}decode(){for(;this.readCursor<this.readerDataView.byteLength;){let e=this.read();if(e>=128){let i=e-128,t=this.readNextPixel();for(let r=0;r<=i;++r)this.writePixel(t)}else{let i=e;for(let t=0;t<=i;++t){let r=this.readNextPixel();this.writePixel(r)}}}return this.decodedArrayBuffer}};function g(s,e,i,t){return new d(s,e,i,t).decode()}var h=class{arrayBuffer;dataView;colorMapType;imageType;xOrigin;yOrigin;imageWidth;imageHeight;pixelSize;imageDescriptor;imageIdentificationFieldLength;imageDataFieldOffset;colorMapOrigin;colorMapLength;colorMapPixelSize;constructor(e){this.arrayBuffer=e,this.dataView=new DataView(e),this.imageIdentificationFieldLength=this.dataView.getUint8(0),this.colorMapType=this.dataView.getUint8(1),this.imageType=this.dataView.getUint8(2),this.colorMapOrigin=this.dataView.getUint16(3,!0),this.colorMapLength=this.dataView.getUint16(5,!0),this.colorMapPixelSize=this.dataView.getUint8(7)/8,this.xOrigin=this.dataView.getUint16(8),this.yOrigin=this.dataView.getUint16(10),this.imageWidth=this.dataView.getUint16(12,!0),this.imageHeight=this.dataView.getUint16(14,!0),this.pixelSize=this.dataView.getUint8(16)/8,this.imageDescriptor=this.dataView.getUint8(17),this.imageDataFieldOffset=this.getImageDataFieldOffset()}getImageDataFieldOffset(){switch(this.colorMapType){case 0:return 18+this.imageIdentificationFieldLength;case 1:return 18+this.imageIdentificationFieldLength+this.colorMapLength*this.colorMapPixelSize;default:throw new Error(`Color Map Type "${this.colorMapType}" is not supported!`)}}isTopToBottom(){return(4&this.imageDescriptor)===4}getPixelOffset(e,i){let t;if(this.isTopToBottom()?t=i*this.imageWidth*this.pixelSize+e*this.pixelSize:t=(this.imageHeight-i-1)*this.imageWidth*this.pixelSize+e*this.pixelSize,t+=this.imageDataFieldOffset,this.colorMapType===0)return t;if(this.colorMapType===1)return this.pixelSize===2?t=this.dataView.getUint16(t,!0):t=this.dataView.getUint8(t),18+this.imageIdentificationFieldLength+this.colorMapOrigin+t*this.colorMapPixelSize;throw new Error(`Color map type ${this.colorMapType} is not supported`)}getPixelColor(e,i){let t=this.colorMapType===0?this.pixelSize:this.colorMapPixelSize,r=this.getPixelOffset(e,i);switch(t){case 3:{let a=this.dataView.getUint8(r),o=this.dataView.getUint8(r+1);return{red:this.dataView.getUint8(r+2),green:o,blue:a,alpha:255}}default:throw new Error(`Pixel Size (${this.pixelSize}) is not supported!`)}}decodeRunLengthEncoding(){let e=g(this.arrayBuffer.slice(this.imageDataFieldOffset),this.imageWidth,this.imageHeight,this.pixelSize),i=new ArrayBuffer(e.byteLength+this.imageDataFieldOffset),t=new DataView(i);for(let a=0;a<this.imageDataFieldOffset;++a){let o=this.dataView.getUint8(a);t.setUint8(a,o)}let r=new DataView(e);for(let a=0;a<e.byteLength;++a){let o=r.getUint8(a);t.setUint8(this.imageDataFieldOffset+a,o)}this.arrayBuffer=i,this.dataView=t}draw(e){let i=e.getContext("2d");if(!i){alert("Failed to get canvas context");return}this.imageType>8&&this.decodeRunLengthEncoding(),i.clearRect(0,0,e.width,e.height),e.width=this.imageWidth,e.height=this.imageHeight;let t=i.createImageData(this.imageWidth,this.imageHeight);for(let r=0;r<this.imageHeight;++r)for(let a=0;a<this.imageWidth;++a){let o=this.getPixelColor(a,r),n=r*this.imageWidth*4+a*4;t.data[n]=o.red,t.data[n+1]=o.green,t.data[n+2]=o.blue,t.data[n+3]=o.alpha}i.putImageData(t,0,0)}toTable(){let e=this.getStats(),i={};for(let[t,r]of Object.entries(e)){let o=`${t[0].toUpperCase()}${t.replace(/([A-Z])/g," $1").substring(1)}`;i[o]=r}return i}getStats(){return{colorMapType:this.colorMapType,imageType:l[this.imageType],xOrigin:this.xOrigin,yOrigin:this.yOrigin,imageWidth:this.imageWidth,imageHeight:this.imageHeight,pixelSize:this.pixelSize,imageDescriptor:this.imageDescriptor.toString(2),imageIdentificationFieldLength:this.imageIdentificationFieldLength,topToBottom:this.isTopToBottom(),colorMapOrigin:this.colorMapOrigin,colorMapLength:this.colorMapLength,colorMapPixelSize:this.colorMapPixelSize}}};new EventSource("/esbuild").addEventListener("change",()=>location.reload());var p=document.querySelector("input[type=file]"),f=document.querySelector("canvas"),u=document.querySelector("table"),m=document.querySelector("#row");function w(s){u.innerHTML="";let e=s.toTable();console.table(e);for(let[i,t]of Object.entries(e)){let r=m.content.cloneNode(!0),a=r.querySelectorAll("td");a[0].innerText=i,a[1].innerText=t,u.appendChild(r)}}async function x(){try{let{files:s}=p;if(!s?.length)return;let e=s.item(0);if(!e)return;let i=await c(e),t=new h(i);w(t),t.draw(f)}catch(s){alert(s.message)}}p.addEventListener("change",()=>{x()});})();
